# Telegram Integration Plan for Lumina Platform


## Executive Summary


This document outlines the comprehensive plan to integrate Telegram bot functionality into the Lumina platform, enabling deployed Azure Function chatbots to be accessible through Telegram. The integration leverages patterns from the existing `chatbot-middleware` system while adapting them for Lumina's Node.js architecture.


---


## 1. Architecture Overview


### 1.1 Current System Analysis


#### chatbot-middleware System (Reference Implementation)
- **Telegram Bot Handler**: Azure Function (`mkiats-dev-telegram/`) that receives Telegram webhook messages
- **Message Flow**: Telegram webhook â†’ Azure Function â†’ CosmosDB lookup â†’ Forward to chatbot endpoint â†’ Return response
- **Database**: Azure CosmosDB with two containers:
 - `UserDB.users` (partition key: `/partition` - first 4 chars of user ID)
 - `ChatbotDB.chatbots` (partition key: `/developer_id`)
- **Key Features**:
 - `/start` command: Welcome message
 - `/list` command: Shows active chatbots with `telegram_support=true`
 - `/select` callback: Sets user's selected chatbot
 - Query forwarding: Sends messages to selected chatbot's endpoint


#### Lumina System (Target Platform)
- **Backend**: Node.js/Express (`lumina-web-be/`)
- **Database**: MongoDB (via Mongoose)
- **Current Models**:
 - `Plugin` - represents a chatbot/plugin
 - `User` - represents a developer/user
- **Deployment**: `deploymentService.js` handles Azure Function deployment via Kudu API


### 1.2 Target Architecture


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LUMINA PLATFORM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Lumina     â”‚â”€â”€â”€â”€â–¶â”‚  Telegram Bot    â”‚â”€â”€â”€â”€â–¶â”‚   Azure Function        â”‚  â”‚
â”‚  â”‚   Frontend   â”‚     â”‚  Service (New)   â”‚     â”‚   (Deployed Chatbot)    â”‚  â”‚
â”‚  â”‚              â”‚     â”‚                  â”‚     â”‚                         â”‚  â”‚
â”‚  â”‚ - Toggle     â”‚     â”‚ - Webhook recv   â”‚     â”‚ - /api/http_trigger     â”‚  â”‚
â”‚  â”‚   Telegram   â”‚     â”‚ - Command handle â”‚     â”‚ - Query processing      â”‚  â”‚
â”‚  â”‚   Support    â”‚     â”‚ - Message route  â”‚     â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                          â”‚                   â”‚
â”‚         â”‚                     â”‚                          â”‚                   â”‚
â”‚         â–¼                     â–¼                          â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                   â”‚
â”‚  â”‚                     MongoDB                          â”‚â”‚                   â”‚
â”‚  â”‚                                                      â”‚â”‚                   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚                   â”‚
â”‚  â”‚  â”‚    Plugin       â”‚  â”‚    TelegramUser (New)     â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â”‚  Collection     â”‚  â”‚      Collection           â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                           â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â”‚ + telegramSupportâ”‚ â”‚ - telegramId (partition) â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â”‚ + isActive      â”‚  â”‚ - selectedPluginId       â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â”‚ + endpoint      â”‚  â”‚ - isQuerying             â”‚ â”‚â”‚                   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                   â”‚
â”‚                                                          â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                             â”‚
                             â”‚ Telegram Bot API
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TELEGRAM                                             â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  End User   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Telegram Bot API                  â”‚â”‚
â”‚  â”‚  (Mobile/   â”‚                     â”‚   api.telegram.org                  â”‚â”‚
â”‚  â”‚   Desktop)  â”‚                     â”‚                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   - Webhook: POST to Lumina         â”‚â”‚
â”‚                                      â”‚   - sendMessage: Respond to users   â”‚â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 1.3 Data Flow Diagrams


#### Deployment Flow with Telegram Registration
```
Developer                 Lumina Frontend      Lumina Backend       Azure Functions       MongoDB
   â”‚                          â”‚                    â”‚                     â”‚                  â”‚
   â”‚  Upload ZIP + Toggle     â”‚                    â”‚                     â”‚                  â”‚
   â”‚  Telegram Support        â”‚                    â”‚                     â”‚                  â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                     â”‚                  â”‚
   â”‚                          â”‚ POST /api/deploy   â”‚                     â”‚                  â”‚
   â”‚                          â”‚ + telegramSupport  â”‚                     â”‚                  â”‚
   â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                  â”‚
   â”‚                          â”‚                    â”‚  Deploy Function    â”‚                  â”‚
   â”‚                          â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
   â”‚                          â”‚                    â”‚  Function URL       â”‚                  â”‚
   â”‚                          â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
   â”‚                          â”‚                    â”‚                     â”‚                  â”‚
   â”‚                          â”‚                    â”‚  Update Plugin      â”‚                  â”‚
   â”‚                          â”‚                    â”‚  (telegramSupport,  â”‚                  â”‚
   â”‚                          â”‚                    â”‚   endpoint, status) â”‚                  â”‚
   â”‚                          â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚                    â”‚                     â”‚                  â”‚
   â”‚  Deployment Success      â”‚                    â”‚                     â”‚                  â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                  â”‚
```


#### Telegram Message Flow
```
Telegram User           Telegram API         Lumina Telegram Service      MongoDB            Azure Function
   â”‚                       â”‚                        â”‚                       â”‚                    â”‚
   â”‚  /list command        â”‚                        â”‚                       â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚                       â”‚                    â”‚
   â”‚                       â”‚  Webhook POST          â”‚                       â”‚                    â”‚
   â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Query plugins        â”‚                    â”‚
   â”‚                       â”‚                        â”‚  (activated=true,     â”‚                    â”‚
   â”‚                       â”‚                        â”‚   telegramSupport)    â”‚                    â”‚
   â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Plugin list          â”‚                    â”‚
   â”‚                       â”‚                        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚  sendMessage           â”‚                       â”‚                    â”‚
   â”‚                       â”‚  (inline keyboard)     â”‚                       â”‚                    â”‚
   â”‚                       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
   â”‚  Chatbot list         â”‚                        â”‚                       â”‚                    â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚                       â”‚                    â”‚
   â”‚  Select chatbot       â”‚                        â”‚                       â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚                       â”‚                    â”‚
   â”‚                       â”‚  Callback POST         â”‚                       â”‚                    â”‚
   â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Upsert TelegramUser  â”‚                    â”‚
   â”‚                       â”‚                        â”‚  (selectedPluginId)   â”‚                    â”‚
   â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
   â”‚  Confirmation         â”‚                        â”‚                       â”‚                    â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚                       â”‚                    â”‚
   â”‚  User query           â”‚                        â”‚                       â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚                       â”‚                    â”‚
   â”‚                       â”‚  Webhook POST          â”‚                       â”‚                    â”‚
   â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Get TelegramUser     â”‚                    â”‚
   â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
   â”‚                       â”‚                        â”‚  selectedPluginId     â”‚                    â”‚
   â”‚                       â”‚                        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Get Plugin endpoint  â”‚                    â”‚
   â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
   â”‚                       â”‚                        â”‚  Plugin data          â”‚                    â”‚
   â”‚                       â”‚                        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚                        â”‚                       â”‚                    â”‚
   â”‚                       â”‚                        â”‚  POST /api/http_trigger                   â”‚
   â”‚                       â”‚                        â”‚  {query: user_message}                    â”‚
   â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                       â”‚                        â”‚  Chatbot response                         â”‚
   â”‚                       â”‚                        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                       â”‚  sendMessage           â”‚                       â”‚                    â”‚
   â”‚                       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
   â”‚  Chatbot response     â”‚                        â”‚                       â”‚                    â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚                       â”‚                    â”‚
```


---


## 2. Database Schema Changes


### 2.1 Plugin Model Updates (MongoDB)


**File**: `Lumina/lumina-web-be/models/plugin.model.js`


Add the following fields to the existing PluginSchema:


```javascript
// NEW: Telegram integration fields
telegramSupport: {
 type: Boolean,
 default: false,
 required: false,
},
telegramDisplayName: {
 type: String,
 required: false,
 maxlength: 32,
 // Human-readable name for Telegram bot list
 // Defaults to plugin 'name' if not provided
},
```


**Migration Strategy**: No migration needed - new fields have defaults. Existing plugins will have `telegramSupport: false` by default.


### 2.2 New TelegramUser Model (MongoDB)


**File**: `Lumina/lumina-web-be/models/telegramUser.model.js` (NEW)


```javascript
const mongoose = require("mongoose");


const TelegramUserSchema = mongoose.Schema(
 {
   telegramId: {
     type: String,
     required: [true, "Telegram ID is required"],
     unique: true,
     index: true,
   },
   selectedPluginId: {
     type: mongoose.Schema.Types.ObjectId,
     ref: "Plugin",
     required: false,
     default: null,
   },
   isQuerying: {
     type: Boolean,
     default: false,
   },
   lastActivity: {
     type: Date,
     default: Date.now,
   },
 },
 {
   timestamps: true,
 }
);


const TelegramUser = mongoose.model("TelegramUser", TelegramUserSchema);
module.exports = TelegramUser;
```


### 2.3 Schema Comparison: chatbot-middleware vs Lumina


| chatbot-middleware (CosmosDB) | Lumina (MongoDB) | Notes |
|-------------------------------|------------------|-------|
| `ChatbotDB.chatbots` | `Plugin` collection | Extended with `telegramSupport` |
| `id` (UUID) | `_id` (ObjectId) | MongoDB auto-generated |
| `developer_id` (partition key) | `userEmail` | User identifier |
| `telegram_support` (boolean) | `telegramSupport` (boolean) | Same purpose |
| `status: active/inactive/debug` | `activated` (boolean) | Simplified |
| `endpoint` | `endpoint` + `path` | Combined for full URL |
| `UserDB.users` | `TelegramUser` collection | Telegram-specific users |
| `partition` (first 4 chars of ID) | `telegramId` (indexed) | MongoDB uses indexes |
| `selected_chatbot_id` | `selectedPluginId` (ObjectId ref) | Plugin reference |
| `is_querying` | `isQuerying` | Prevent concurrent queries |


---


## 3. Implementation Steps


### Step 1: Set Up Telegram Bot Infrastructure


**Objective**: Create a Telegram bot and configure webhook.


#### 1.1 Create Telegram Bot (Manual - One-time Setup)
1. Open Telegram and message [@BotFather](https://t.me/botfather)
2. Send `/newbot` and follow prompts
3. Save the bot token (format: `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`)
4. Send `/setcommands` and configure:
  ```
  start - Welcome message and introduction
  list - Show available chatbots
  help - Show help information
  ```


#### 1.2 Add Environment Variables
**File**: `Lumina/lumina-web-be/.env` (add to existing)


```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_API_URL=https://api.telegram.org/bot
TELEGRAM_WEBHOOK_PATH=/api/telegram/webhook
```


#### 1.3 Register Webhook (One-time setup via curl)
```bash
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
 -H "Content-Type: application/json" \
 -d '{"url": "https://your-lumina-backend.azurewebsites.net/api/telegram/webhook"}'
```


---


### Step 2: Create Telegram Service (New Files)


**Objective**: Implement Telegram message handling service.


#### 2.1 Telegram Client Service
**File**: `Lumina/lumina-web-be/services/telegramService.js` (NEW)


```javascript
/**
* Telegram Service
* Handles Telegram Bot API communication
* Ported from: chatbot-middleware/mkiats-dev-telegram/telegramClient.py
*/


const axios = require("axios");
const Plugin = require("../models/plugin.model");
const TelegramUser = require("../models/telegramUser.model");


class TelegramService {
 constructor() {
   this.botToken = process.env.TELEGRAM_BOT_TOKEN;
   this.apiUrl = process.env.TELEGRAM_API_URL || "https://api.telegram.org/bot";
 }


 /**
  * Parse incoming Telegram webhook payload
  */
 parsePayload(payload) {
   const message = payload.message || {};
   const callbackQuery = payload.callback_query || {};
   let chatId = null;
   let text = null;
   let callbackData = null;


   if (message && message.chat) {
     chatId = message.chat.id.toString();
     text = message.text || null;
   }
   if (callbackQuery && callbackQuery.message) {
     chatId = callbackQuery.message.chat.id.toString();
     callbackData = callbackQuery.data || null;
   }


   return { message, chatId, text, callbackQuery, callbackData };
 }


 /**
  * Send message via Telegram Bot API
  */
 async sendMessage(chatId, text, options = {}) {
   const url = `${this.apiUrl}${this.botToken}/sendMessage`;
   const payload = {
     chat_id: chatId,
     text: text,
     ...options,
   };


   try {
     await axios.post(url, payload);
     return { success: true };
   } catch (error) {
     console.error("Telegram sendMessage error:", error.message);
     return { success: false, error: error.message };
   }
 }


 /**
  * Process incoming webhook message
  * Main entry point - routes to appropriate handler
  */
 async processMessage(payload) {
   try {
     const { chatId, text, callbackData } = this.parsePayload(payload);


     if (!chatId) {
       return { success: false, error: "No chat ID found" };
     }


     // Route to appropriate handler
     if (text === "/start") {
       return await this.handleStart(chatId);
     } else if (text === "/list") {
       return await this.handleList(chatId);
     } else if (text === "/help") {
       return await this.handleHelp(chatId);
     } else if (callbackData && callbackData.startsWith("select_")) {
       return await this.handleSelect(chatId, callbackData);
     } else if (text && !text.startsWith("/")) {
       return await this.handleQuery(chatId, text);
     } else {
       return await this.sendMessage(chatId, "Unknown command. Use /help for available commands.");
     }
   } catch (error) {
     console.error("processMessage error:", error);
     return { success: false, error: error.message };
   }
 }


 /**
  * Handle /start command
  */
 async handleStart(chatId) {
   const welcomeMsg =
     "ğŸ¤– Welcome to Lumina Chatbot Marketplace!\n\n" +
     "You can interact with AI chatbots deployed by developers.\n\n" +
     "Commands:\n" +
     "/list - Show available chatbots\n" +
     "/help - Show this help message\n\n" +
     "Get started by typing /list to see available chatbots!";


   return await this.sendMessage(chatId, welcomeMsg);
 }


 /**
  * Handle /help command
  */
 async handleHelp(chatId) {
   const helpMsg =
     "ğŸ“– Lumina Bot Help\n\n" +
     "Commands:\n" +
     "/start - Welcome message\n" +
     "/list - Show available chatbots\n" +
     "/help - Show this help\n\n" +
     "After selecting a chatbot, simply type your message to chat with it!";


   return await this.sendMessage(chatId, helpMsg);
 }


 /**
  * Handle /list command - show available chatbots
  */
 async handleList(chatId) {
   try {
     // Query plugins with telegramSupport enabled and activated
     const plugins = await Plugin.find({
       activated: true,
       telegramSupport: true,
     }).select("_id name telegramDisplayName description");


     if (plugins.length === 0) {
       return await this.sendMessage(chatId,
         "No chatbots available at the moment. Check back later!");
     }


     // Build inline keyboard
     const inlineKeyboard = plugins.map((plugin) => ([{
       text: plugin.telegramDisplayName || plugin.name,
       callback_data: `select_${plugin._id}`,
     }]));


     return await this.sendMessage(chatId, "ğŸ“‹ Available chatbots:", {
       reply_markup: { inline_keyboard: inlineKeyboard },
     });
   } catch (error) {
     console.error("handleList error:", error);
     return await this.sendMessage(chatId,
       "Error fetching chatbot list. Please try again later.");
   }
 }


 /**
  * Handle chatbot selection callback
  */
 async handleSelect(chatId, callbackData) {
   try {
     const pluginId = callbackData.replace("select_", "");


     // Verify plugin exists and is active
     const plugin = await Plugin.findById(pluginId);
     if (!plugin) {
       return await this.sendMessage(chatId,
         "Chatbot not found. Use /list to see available chatbots.");
     }
     if (!plugin.activated || !plugin.telegramSupport) {
       return await this.sendMessage(chatId,
         "This chatbot is no longer available. Use /list to refresh.");
     }


     // Upsert TelegramUser with selected plugin
     await TelegramUser.findOneAndUpdate(
       { telegramId: chatId },
       {
         telegramId: chatId,
         selectedPluginId: plugin._id,
         lastActivity: new Date(),
       },
       { upsert: true, new: true }
     );


     const displayName = plugin.telegramDisplayName || plugin.name;
     return await this.sendMessage(chatId,
       `âœ… ${displayName} selected!\n\nYou can now start chatting. Just type your message.`);
   } catch (error) {
     console.error("handleSelect error:", error);
     return await this.sendMessage(chatId,
       "Error selecting chatbot. Please try again.");
   }
 }


 /**
  * Handle user query - forward to selected chatbot
  */
 async handleQuery(chatId, userQuery) {
   try {
     // Get user's selected plugin
     const telegramUser = await TelegramUser.findOne({ telegramId: chatId });


     if (!telegramUser || !telegramUser.selectedPluginId) {
       return await this.sendMessage(chatId,
         "No chatbot selected. Use /list to choose a chatbot first.");
     }


     // Check if already querying (prevent concurrent requests)
     if (telegramUser.isQuerying) {
       return await this.sendMessage(chatId,
         "â³ Please wait for the current query to complete.");
     }


     // Get plugin details
     const plugin = await Plugin.findById(telegramUser.selectedPluginId);
     if (!plugin || !plugin.activated || !plugin.telegramSupport) {
       return await this.sendMessage(chatId,
         "Selected chatbot is no longer available. Use /list to choose another.");
     }


     // Set querying flag
     await TelegramUser.updateOne(
       { telegramId: chatId },
       { isQuerying: true, lastActivity: new Date() }
     );


     try {
       // Build full endpoint URL
       const chatbotUrl = `${plugin.endpoint}${plugin.path}`;


       // Forward query to chatbot
       const response = await axios.post(chatbotUrl, {
         query: userQuery,
       }, {
         timeout: 30000, // 30 second timeout
         headers: {
           "Content-Type": "application/json",
         },
       });


       // Parse response - handle both string and object responses
       let responseText;
       if (typeof response.data === "string") {
         responseText = response.data;
       } else if (response.data && response.data.response) {
         responseText = response.data.response;
       } else if (response.data && response.data.message) {
         responseText = response.data.message;
       } else {
         responseText = JSON.stringify(response.data);
       }


       // Telegram message limit is 4096 characters
       if (responseText.length > 4000) {
         responseText = responseText.substring(0, 4000) + "... (truncated)";
       }


       return await this.sendMessage(chatId, responseText);
     } finally {
       // Always clear querying flag
       await TelegramUser.updateOne(
         { telegramId: chatId },
         { isQuerying: false }
       );
     }
   } catch (error) {
     console.error("handleQuery error:", error);


     // Clear querying flag on error
     await TelegramUser.updateOne(
       { telegramId: chatId },
       { isQuerying: false }
     ).catch(() => {});


     if (error.code === "ECONNABORTED" || error.code === "ETIMEDOUT") {
       return await this.sendMessage(chatId,
         "â±ï¸ The chatbot took too long to respond. Please try again.");
     }


     return await this.sendMessage(chatId,
       "âŒ Error communicating with chatbot. Please try again later.");
   }
 }
}


module.exports = new TelegramService();
```


---


### Step 3: Create Telegram Routes and Controller


**Objective**: Add API endpoint for Telegram webhook.


#### 3.1 Telegram Controller
**File**: `Lumina/lumina-web-be/controllers/telegram.controller.js` (NEW)


```javascript
/**
* Telegram Controller
* Handles Telegram webhook requests
*/


const telegramService = require("../services/telegramService");


/**
* POST /api/telegram/webhook
* Receives Telegram webhook updates
*/
exports.handleWebhook = async (req, res) => {
 try {
   // Telegram expects 200 OK response immediately
   // Process message asynchronously
   const payload = req.body;


   // Validate payload has required fields
   if (!payload || (!payload.message && !payload.callback_query)) {
     return res.status(200).json({ ok: true });
   }


   // Process message (don't await - respond immediately)
   telegramService.processMessage(payload).catch((err) => {
     console.error("Telegram webhook processing error:", err);
   });


   // Always return 200 to Telegram
   return res.status(200).json({ ok: true });
 } catch (error) {
   console.error("Webhook error:", error);
   // Still return 200 to prevent Telegram from retrying
   return res.status(200).json({ ok: true });
 }
};


/**
* GET /api/telegram/health
* Health check for Telegram integration
*/
exports.healthCheck = async (req, res) => {
 const botToken = process.env.TELEGRAM_BOT_TOKEN;
 return res.status(200).json({
   status: "ok",
   telegramConfigured: !!botToken,
 });
};
```


#### 3.2 Telegram Routes
**File**: `Lumina/lumina-web-be/routes/telegram.route.js` (NEW)


```javascript
/**
* Telegram Routes
* Handles Telegram Bot webhook and health endpoints
*/


const express = require("express");
const router = express.Router();
const telegramController = require("../controllers/telegram.controller");


/**
* POST /api/telegram/webhook
* Telegram webhook endpoint
*/
router.post("/webhook", telegramController.handleWebhook);


/**
* GET /api/telegram/health
* Health check endpoint
*/
router.get("/health", telegramController.healthCheck);


module.exports = router;
```


#### 3.3 Register Routes in index.js
**File**: `Lumina/lumina-web-be/index.js` (MODIFY)


Add the following line in the "Feature routes" section:


```javascript
/* ---------- Feature routes ---------- */
app.use("/user", require("./routes/user.route"));
app.use("/plugin", require("./routes/plugin.route"));
app.use("/api/deploy", require("./routes/deploy.route"));
app.use("/api/telegram", require("./routes/telegram.route")); // NEW: Telegram webhook
```


---


### Step 4: Extend Deploy Controller for Telegram Registration


**Objective**: Update deployment flow to handle `telegramSupport` flag.


#### 4.1 Update Plugin Model
**File**: `Lumina/lumina-web-be/models/plugin.model.js` (MODIFY)


Add the following fields after `functionAppName`:


```javascript
// NEW: Telegram integration fields
telegramSupport: {
 type: Boolean,
 default: false,
 required: false,
},
telegramDisplayName: {
 type: String,
 required: false,
 maxlength: 32,
},
```


#### 4.2 Update Deploy Controller
**File**: `Lumina/lumina-web-be/controllers/deploy.controller.js` (MODIFY)


In the `deployPlugin` function, after updating plugin deployment info:


```javascript
// Update plugin with deployment info and auto-activate
plugin.deploymentType = "managed";
plugin.functionAppName = functionAppName;
plugin.endpoint = deployResult.functionUrl;
plugin.path = "/api/http_trigger";
plugin.activated = true;


// NEW: Handle Telegram support from request
if (req.body.telegramSupport !== undefined) {
 plugin.telegramSupport = req.body.telegramSupport === true || req.body.telegramSupport === "true";
}
if (req.body.telegramDisplayName) {
 plugin.telegramDisplayName = req.body.telegramDisplayName;
}
```


---


### Step 5: Add Telegram UI Toggle in Frontend


**Objective**: Add UI toggle for "Enable Telegram Support" in plugin creation/deployment.


#### 5.1 Update Plugin Creation Form
**File**: `Lumina/lumina-web-fe/src/components/create/` (MODIFY existing form)


Add toggle component:


```jsx
// In the plugin creation/edit form, add:
<FormControlLabel
 control={
   <Switch
     checked={telegramSupport}
     onChange={(e) => setTelegramSupport(e.target.checked)}
     name="telegramSupport"
   />
 }
 label="Enable Telegram Support"
/>


{telegramSupport && (
 <TextField
   label="Telegram Display Name (optional)"
   value={telegramDisplayName}
   onChange={(e) => setTelegramDisplayName(e.target.value)}
   helperText="Name shown in Telegram bot. Defaults to plugin name."
   inputProps={{ maxLength: 32 }}
 />
)}
```


#### 5.2 Update Deploy Request
**File**: `Lumina/lumina-web-fe/src/` (MODIFY deployment API call)


Include `telegramSupport` in the deployment form data:


```javascript
const formData = new FormData();
formData.append("file", zipFile);
formData.append("userEmail", userEmail);
formData.append("telegramSupport", telegramSupport.toString());
if (telegramDisplayName) {
 formData.append("telegramDisplayName", telegramDisplayName);
}
```


---


### Step 6: Testing and Validation


**Objective**: Ensure complete functionality through comprehensive testing.


#### 6.1 Unit Tests (Add to existing test suite)


**File**: `Lumina/lumina-web-be/tests/telegram.test.js` (NEW)


```javascript
const telegramService = require("../services/telegramService");


describe("TelegramService", () => {
 describe("parsePayload", () => {
   it("should parse message payload correctly", () => {
     const payload = {
       message: {
         chat: { id: 123456 },
         text: "/start",
       },
     };
     const result = telegramService.parsePayload(payload);
     expect(result.chatId).toBe("123456");
     expect(result.text).toBe("/start");
   });


   it("should parse callback query correctly", () => {
     const payload = {
       callback_query: {
         message: { chat: { id: 789 } },
         data: "select_abc123",
       },
     };
     const result = telegramService.parsePayload(payload);
     expect(result.chatId).toBe("789");
     expect(result.callbackData).toBe("select_abc123");
   });
 });
});
```


#### 6.2 Integration Test Scenarios


| Test Case | Steps | Expected Result |
|-----------|-------|-----------------|
| Webhook receives /start | POST to /api/telegram/webhook with /start message | Returns 200, user receives welcome message |
| List empty chatbots | POST /list when no plugins enabled | Returns "No chatbots available" |
| List with chatbots | POST /list with plugins having telegramSupport=true | Returns inline keyboard with chatbot names |
| Select chatbot | Click inline button | TelegramUser created/updated, confirmation sent |
| Query without selection | Send message without selecting chatbot | Returns "No chatbot selected" |
| Query with selection | Send message after selecting chatbot | Query forwarded to Azure Function, response returned |
| Chatbot timeout | Query chatbot that times out | Returns timeout error message |
| Concurrent query prevention | Send multiple queries rapidly | Second query returns "Please wait" |


#### 6.3 End-to-End Test Flow


```bash
# 1. Deploy a plugin with Telegram support
curl -X POST "https://lumina-backend.azurewebsites.net/api/deploy/{pluginId}" \
 -F "file=@chatbot.zip" \
 -F "userEmail=dev@example.com" \
 -F "telegramSupport=true" \
 -F "telegramDisplayName=My AI Bot"


# 2. Verify webhook is receiving (check Telegram Bot API)
curl "https://api.telegram.org/bot{TOKEN}/getWebhookInfo"


# 3. Test via Telegram app:
#    - Send /start to bot
#    - Send /list
#    - Click chatbot button
#    - Send a query message
```


---


## 4. Technical Specifications


### 4.1 API Endpoints


| Endpoint | Method | Description | Auth |
|----------|--------|-------------|------|
| `/api/telegram/webhook` | POST | Telegram webhook receiver | None (Telegram-only) |
| `/api/telegram/health` | GET | Health check | None |
| `/api/deploy/:pluginId` | POST | Deploy with telegramSupport | userEmail |


### 4.2 Environment Variables


| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `TELEGRAM_BOT_TOKEN` | Yes | Bot token from BotFather | `123456:ABC-DEF...` |
| `TELEGRAM_API_URL` | No | Telegram API base URL | `https://api.telegram.org/bot` |
| `TELEGRAM_WEBHOOK_PATH` | No | Webhook path | `/api/telegram/webhook` |


### 4.3 Error Handling


| Error Scenario | Handler Behavior | User Message |
|----------------|------------------|--------------|
| Invalid payload | Log error, return 200 | (none) |
| Plugin not found | Log, send message | "Chatbot not found" |
| Plugin inactive | Send message | "Chatbot no longer available" |
| Azure Function timeout | Catch timeout error | "Chatbot took too long" |
| Azure Function error | Catch error, log | "Error communicating with chatbot" |
| Database error | Catch, log, send message | "Error occurred, try again" |


### 4.4 Rate Limiting Considerations


Telegram has built-in rate limiting:
- 30 messages/second to same chat
- 1 message/second to same chat (for bots)


Recommended additional limits for Lumina:
- Query timeout: 30 seconds
- Concurrent queries per user: 1 (via `isQuerying` flag)
- Consider adding IP-based rate limiting for webhook endpoint


### 4.5 Security Considerations


1. **Webhook Validation**:
  - Currently relies on secret URL path
  - Consider adding Telegram's secret_token header validation:
  ```javascript
  // In setWebhook
  await axios.post(`${apiUrl}/setWebhook`, {
   url: webhookUrl,
   secret_token: process.env.TELEGRAM_WEBHOOK_SECRET,
  });


  // In webhook handler
  const secret = req.headers["x-telegram-bot-api-secret-token"];
  if (secret !== process.env.TELEGRAM_WEBHOOK_SECRET) {
   return res.status(403).json({ error: "Invalid secret" });
  }
  ```


2. **Input Sanitization**:
  - User queries are passed directly to Azure Functions
  - Azure Functions should handle their own input validation
  - Consider adding max query length (e.g., 4096 chars)


3. **Plugin Endpoint Validation**:
  - Only forward queries to HTTPS endpoints
  - Validate endpoint is in expected domain if possible


---


## 5. Code Reuse Strategy


### 5.1 Components Adapted from chatbot-middleware


| Source File | Target File | Adaptation Notes |
|-------------|-------------|------------------|
| `_common.py` â†’ `parsePayload()` | `telegramService.js` â†’ `parsePayload()` | Direct port, Python â†’ JS |
| `_common.py` â†’ `_execute_url()` | `telegramService.js` â†’ `sendMessage()` | Use axios instead of httpx |
| `_common.py` â†’ `_query_chatbot()` | `telegramService.js` â†’ `handleQuery()` | Use axios, async/await |
| `_startHandler.py` | `telegramService.js` â†’ `handleStart()` | Direct port |
| `_listHandler.py` | `telegramService.js` â†’ `handleList()` | Use Mongoose instead of CosmosDB |
| `_selectHandler.py` | `telegramService.js` â†’ `handleSelect()` | Use Mongoose, ObjectId refs |
| `_queryHandler.py` | `telegramService.js` â†’ `handleQuery()` | Use Mongoose, axios |


### 5.2 Key Differences


| Aspect | chatbot-middleware (Python) | Lumina (Node.js) |
|--------|----------------------------|------------------|
| HTTP Client | httpx, aiohttp | axios |
| Database | Azure CosmosDB | MongoDB (Mongoose) |
| Async Pattern | async/await (asyncio) | async/await (native) |
| Partition Key | Custom (first 4 chars) | MongoDB ObjectId |
| Function Runtime | Azure Functions (Python) | Express.js |


---


## 6. Testing Plan


### 6.1 Unit Tests


| Component | Test Cases | Coverage Target |
|-----------|------------|-----------------|
| `telegramService.parsePayload` | Message, callback, empty payload | 100% |
| `telegramService.handleStart` | Welcome message sent | 100% |
| `telegramService.handleList` | Empty list, with plugins, error | 90% |
| `telegramService.handleSelect` | Valid, invalid, inactive plugin | 90% |
| `telegramService.handleQuery` | Success, timeout, no selection | 85% |
| `TelegramUser` model | Create, update, find | 90% |
| Plugin model (telegram fields) | Default values, validation | 100% |


### 6.2 Integration Tests


| Test Suite | Components | Tools |
|------------|------------|-------|
| Webhook integration | Route â†’ Controller â†’ Service | Jest + Supertest |
| Database operations | Service â†’ MongoDB | Jest + mongodb-memory-server |
| External API calls | Service â†’ Telegram API | Jest + nock (mocking) |


### 6.3 End-to-End Tests


| Scenario | Pre-requisites | Steps | Validation |
|----------|----------------|-------|------------|
| Full flow | Deployed chatbot | /start â†’ /list â†’ select â†’ query | Message received |
| Error recovery | No chatbots | /list | "No chatbots" message |
| Concurrent users | Multiple Telegram accounts | Parallel queries | All receive responses |


### 6.4 Rollback Procedures


1. **Disable Telegram Integration**:
  ```bash
  # Remove webhook
  curl "https://api.telegram.org/bot{TOKEN}/deleteWebhook"
  ```


2. **Feature Flag** (recommended for production):
  ```javascript
  // In telegramService.js
  if (process.env.TELEGRAM_ENABLED !== "true") {
   return { success: false, error: "Telegram disabled" };
  }
  ```


3. **Database Rollback**:
  - `TelegramUser` collection can be dropped (no critical data)
  - `Plugin.telegramSupport` field defaults to false (safe)


---


## 7. Implementation Checklist


### Phase 1: Backend Infrastructure
- [ ] Create `telegramUser.model.js`
- [ ] Add `telegramSupport`, `telegramDisplayName` to `plugin.model.js`
- [ ] Create `telegramService.js`
- [ ] Create `telegram.controller.js`
- [ ] Create `telegram.route.js`
- [ ] Register routes in `index.js`
- [ ] Add environment variables


### Phase 2: Deployment Integration
- [ ] Update `deploy.controller.js` to handle `telegramSupport`
- [ ] Test deployment with Telegram flag


### Phase 3: Telegram Bot Setup
- [ ] Create Telegram bot via BotFather
- [ ] Configure bot commands
- [ ] Register webhook with Telegram API


### Phase 4: Frontend Updates
- [ ] Add Telegram toggle to plugin creation form
- [ ] Add Telegram display name field
- [ ] Update deployment API call


### Phase 5: Testing
- [ ] Write unit tests
- [ ] Integration tests
- [ ] End-to-end testing with real Telegram bot
- [ ] Load testing (optional)


### Phase 6: Documentation
- [ ] Update API documentation
- [ ] Create user guide for enabling Telegram support
- [ ] Document troubleshooting steps


---


## 8. Estimated Timeline


| Phase | Duration | Dependencies |
|-------|----------|--------------|
| Backend Infrastructure | 2-3 days | None |
| Deployment Integration | 1 day | Phase 1 |
| Telegram Bot Setup | 1 day | Phase 1 |
| Frontend Updates | 1-2 days | Phase 1, 2 |
| Testing | 2-3 days | All phases |
| Documentation | 1 day | All phases |


**Total Estimated Time**: 8-12 days


---


## 9. Future Enhancements


1. **Multi-bot Support**: Allow developers to create their own Telegram bots linked to their plugins
2. **Conversation History**: Store chat history in MongoDB for context-aware responses
3. **Rich Media**: Support images, files, and inline queries
4. **Analytics**: Track usage metrics per chatbot
5. **Admin Commands**: Allow developers to manage their chatbots via Telegram
6. **Webhook Secret Validation**: Enhanced security with Telegram's secret_token


---


## Appendix A: File Structure After Implementation


```
Lumina/lumina-web-be/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ deploy.controller.js      # MODIFIED
â”‚   â”œâ”€â”€ plugin.controller.js
â”‚   â”œâ”€â”€ telegram.controller.js    # NEW
â”‚   â””â”€â”€ user.controller.js
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ plugin.model.js           # MODIFIED
â”‚   â”œâ”€â”€ telegramUser.model.js     # NEW
â”‚   â””â”€â”€ user.model.js
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ deploy.route.js
â”‚   â”œâ”€â”€ plugin.route.js
â”‚   â”œâ”€â”€ telegram.route.js         # NEW
â”‚   â””â”€â”€ user.route.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ deploymentService.js
â”‚   â””â”€â”€ telegramService.js        # NEW
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ telegram.test.js          # NEW
â””â”€â”€ index.js                      # MODIFIED
```


---


## Appendix B: Quick Reference - chatbot-middleware Code Mapping


| Python (chatbot-middleware) | JavaScript (Lumina) |
|----------------------------|---------------------|
| `TelegramClient._process_message()` | `telegramService.processMessage()` |
| `command_telegram_start()` | `telegramService.handleStart()` |
| `command_telegram_list()` | `telegramService.handleList()` |
| `command_telegram_select()` | `telegramService.handleSelect()` |
| `command_telegram_query()` | `telegramService.handleQuery()` |
| `_parse_payload()` | `telegramService.parsePayload()` |
| `_execute_url()` | `telegramService.sendMessage()` |
| `_query_chatbot()` | Inside `handleQuery()` |
| `_echo_message()` | `telegramService.sendMessage()` |
| `CosmosDB.query_by_key()` | `Model.find()` / `Model.findById()` |
| `CosmosDB.query_by_sql()` | `Model.find({ conditions })` |
| `User` entity | `TelegramUser` model |
| `Chatbot` entity | `Plugin` model |






