# Lumina Platform - Complete Development Context Document


> **Purpose:** This document enables LLMs without codebase access to understand the complete Lumina architecture, provide accurate troubleshooting guidance, and suggest code changes with correct file paths.
>
> **Last Updated:** 2026-06-01


---


## Table of Contents
1. [Platform Overview](#1-platform-overview)
2. [Complete Architecture](#2-complete-architecture)
3. [Project Structure](#3-project-structure)
4. [Data Models & Schemas](#4-data-models--schemas)
5. [API Reference](#5-api-reference)
6. [Key Features & Implementation Details](#6-key-features--implementation-details)
7. [Deployment Architecture](#7-deployment-architecture)
8. [Environment Variables](#8-environment-variables)
9. [Common Issues & Troubleshooting Guide](#9-common-issues--troubleshooting-guide)
10. [Code Patterns & Conventions](#10-code-patterns--conventions)
11. [Critical File Reference](#11-critical-file-reference)
12. [Development Workflow](#12-development-workflow)
13. [Integration Context](#13-integration-context)


---


## 1. Platform Overview


### What is Lumina?
Lumina is a **plugin-based chatbot hosting platform** designed for NTU (Nanyang Technological University). It enables developers to create and deploy custom AI-powered chatbots that students can access through a mobile application.


### Dual Interface System
| Interface | Users | Purpose |
|-----------|-------|---------|
| **Mobile App** | Students | Chat with chatbots, browse available plugins, manage favorites, view conversation history |
| **Web Portal** | Developers | Create plugins, upload OpenAPI schemas, configure endpoints, manage deployments |


### Key Stakeholders
- **Students:** End users who interact with chatbots via mobile app
- **Developers:** Create and maintain plugins via web portal
- **Administrators:** Manage platform, approve plugins (planned feature)


### Value Proposition
- Students get instant access to NTU-specific AI assistants (course help, campus info, etc.)
- Developers can deploy custom chatbots without managing infrastructure
- Platform handles authentication, message routing, and plugin execution


---


## 2. Complete Architecture


### System Components


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              LUMINA PLATFORM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Mobile App     â”‚                      â”‚   Web Portal     â”‚             â”‚
â”‚  â”‚  (React Native)  â”‚                      â”‚    (React)       â”‚             â”‚
â”‚  â”‚  Expo SDK 54     â”‚                      â”‚  Material-UI     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                                         â”‚                        â”‚
â”‚           â”‚ Azure AD Auth                           â”‚ Azure AD Auth          â”‚
â”‚           â–¼                                         â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Mobile Backend  â”‚â—„â”€â”€â”€ Plugin Sync â”€â”€â”€â”€â–ºâ”‚   Web Backend    â”‚             â”‚
â”‚  â”‚   (Express.js)   â”‚    (Timer Function)  â”‚   (Express.js)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                                         â”‚                        â”‚
â”‚           â–¼                                         â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                    MongoDB (Cosmos DB)                        â”‚           â”‚
â”‚  â”‚  â€¢ Users  â€¢ Chatbots  â€¢ Conversations  â€¢ Messages  â€¢ Plugins  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚  Azure OpenAI    â”‚         â”‚ External Plugins â”‚                          â”‚
â”‚  â”‚  (GPT-4o-mini)   â”‚         â”‚ (Developer APIs) â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### Technology Stack


| Component | Technology | Version/Details |
|-----------|------------|-----------------|
| **Mobile Frontend** | React Native + Expo | SDK 54, Expo Router, NativeWind (TailwindCSS) |
| **Web Frontend** | React | v19.1.0, Material-UI, React Router |
| **Mobile Backend** | Node.js + Express | Port 3002, swagger-client, js-yaml |
| **Web Backend** | Node.js + Express | Port 8080, Azure Blob Storage integration |
| **Database** | MongoDB | Azure Cosmos DB (MongoDB API) |
| **Authentication** | Azure AD | OAuth 2.0 / OpenID Connect |
| **AI Integration** | Azure OpenAI | GPT-4o-mini model |
| **Hosting** | Azure | App Services, Static Web Apps |


### Data Flow: User Chat Interaction


```
Student sends message
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile Frontend   â”‚
â”‚ conversation/[id] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ POST /message (save user message)
        â”‚ POST /openai OR POST /custom
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile Backend    â”‚
â”‚ Check chatbotId   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚         â”‚
   â–¼         â–¼
chatbotId   chatbotId
  ="0"      != "0"
   â”‚         â”‚
   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI â”‚ â”‚ Custom Plugin  â”‚
â”‚ GPT-4o â”‚ â”‚ SwaggerClient  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼
   Save AI message
   Return response
```


---


## 3. Project Structure


### Repository Overview
The platform consists of **4 separate repositories**:


```
LumDep/Lumina/
â”œâ”€â”€ lumina-web-fe/          # Web Frontend (Developer Portal)
â”œâ”€â”€ lumina-web-be/          # Web Backend
â”œâ”€â”€ Lumina-Mobile-FE/       # Mobile Frontend (Student App)
â”œâ”€â”€ Lumina-Mobile-BE/       # Mobile Backend
â””â”€â”€ MDs/                    # Documentation
```


### lumina-web-fe (Web Frontend)
```
lumina-web-fe/src/
â”œâ”€â”€ App.js                          # Main app component with routing
â”œâ”€â”€ config.js                       # Azure AD & API configuration
â”œâ”€â”€ index.js                        # React entry point
â”œâ”€â”€ theme.js                        # MUI theme configuration
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”œâ”€â”€ Instruction.jsx         # Step 1: Instructions
â”‚   â”‚   â”œâ”€â”€ PluginDetailsForm.jsx   # Step 2: Plugin details
â”‚   â”‚   â”œâ”€â”€ PluginEndpointForm.jsx  # Step 3: Endpoint config
â”‚   â”‚   â”œâ”€â”€ TestEndpoint.jsx        # Step 4: Endpoint testing
â”‚   â”‚   â”œâ”€â”€ ReviewForm.jsx          # Step 5: Review
â”‚   â”‚   â””â”€â”€ DeploymentModeSelector.jsx # External vs Managed
â”‚   â”œâ”€â”€ plugin/                     # Plugin display components
â”‚   â”œâ”€â”€ dashboard/                  # Dashboard widgets
â”‚   â””â”€â”€ modal/                      # Modal components
â”œâ”€â”€ config/
â”‚   â””â”€â”€ axiosConfig.js              # Axios instance with baseURL
â”œâ”€â”€ context/
â”‚   â””â”€â”€ PluginContext.js            # Plugin state management
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ ProtectedRoute.js           # Auth route wrapper
â”‚   â””â”€â”€ TestEndpoint.js             # Endpoint testing utility
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ developer/
â”‚   â”‚   â””â”€â”€ create/
â”‚   â”‚       â””â”€â”€ Create.jsx          # 5-step plugin wizard
â”‚   â”œâ”€â”€ admin/                      # Admin screens
â”‚   â””â”€â”€ global/
â”‚       â””â”€â”€ Loading.jsx             # Loading component
â””â”€â”€ data/
   â”œâ”€â”€ pluginData.jsx              # Plugin data hooks
   â”œâ”€â”€ contributorData.jsx         # Contributor data
   â””â”€â”€ requestData.jsx             # Request data
```


### lumina-web-be (Web Backend)
```
lumina-web-be/
â”œâ”€â”€ index.js                        # Express server entry (Port 8080)
â”œâ”€â”€ package.json
â”œâ”€â”€ schema.yaml                     # OpenAPI schema template
â”œâ”€â”€ config/
â”‚   â””â”€â”€ axiosConfig.js              # Axios configuration
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ plugin.controller.js        # Plugin CRUD operations
â”‚   â”œâ”€â”€ user.controller.js          # User management
â”‚   â””â”€â”€ deploy.controller.js        # Azure Function deployment
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ plugin.model.js             # Plugin schema (MongoDB)
â”‚   â””â”€â”€ user.model.js               # User schema
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ plugin.route.js             # /plugin routes
â”‚   â”œâ”€â”€ user.route.js               # /user routes
â”‚   â””â”€â”€ deploy.route.js             # /api/deploy routes
â””â”€â”€ services/
   â””â”€â”€ deploymentService.js        # Azure deployment logic
```


### Lumina-Mobile-FE (Mobile Frontend)
```
Lumina-Mobile-FE/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ index.jsx                   # Login screen (Azure AD)
â”‚   â”œâ”€â”€ _layout.jsx                 # Root layout with auth context
â”‚   â”œâ”€â”€ (tabs)/
â”‚   â”‚   â”œâ”€â”€ _layout.jsx             # Tab navigator
â”‚   â”‚   â”œâ”€â”€ home.jsx                # Home screen (chatbot list)
â”‚   â”‚   â””â”€â”€ conversation-history.jsx # Conversation list
â”‚   â”œâ”€â”€ chatbots/
â”‚   â”‚   â”œâ”€â”€ [id].jsx                # Chatbot details screen
â”‚   â”‚   â”œâ”€â”€ discover.jsx            # Browse all chatbots
â”‚   â”‚   â””â”€â”€ favourites.jsx          # User's favorite chatbots
â”‚   â””â”€â”€ conversation/
â”‚       â””â”€â”€ [id].jsx                # Chat interface (CRITICAL)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ChatBotCard.jsx             # Chatbot list item
â”‚   â”œâ”€â”€ CustomConversation.jsx      # Conversation list item
â”‚   â””â”€â”€ MessageInput.jsx            # Chat input component
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ authConfig.js               # Azure AD configuration
â”‚   â””â”€â”€ axiosConfig.js              # Axios with baseURL
â”œâ”€â”€ context/
â”‚   â””â”€â”€ AuthContext.jsx             # Auth state provider
â””â”€â”€ package.json
```


### Lumina-Mobile-BE (Mobile Backend)
```
Lumina-Mobile-BE/
â”œâ”€â”€ index.js                        # Express server entry (Port 3002)
â”œâ”€â”€ package.json
â”œâ”€â”€ config/
â”‚   â””â”€â”€ axiosConfig.js              # Axios configuration
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ chatbot.controller.js       # Chatbot listing/sync
â”‚   â”œâ”€â”€ conversation.controller.js  # Conversation CRUD
â”‚   â”œâ”€â”€ message.controller.js       # Message CRUD
â”‚   â”œâ”€â”€ openai.controller.js        # Azure OpenAI integration
â”‚   â”œâ”€â”€ custom.controller.js        # Custom plugin execution
â”‚   â””â”€â”€ user.controller.js          # User management
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ chatbot.model.js            # (Deprecated - see user.model.js)
â”‚   â”œâ”€â”€ user.model.js               # User + Chatbot schemas
â”‚   â”œâ”€â”€ conversation.model.js       # Conversation schema
â”‚   â””â”€â”€ message.model.js            # Message schema
â””â”€â”€ routes/
   â”œâ”€â”€ chatbot.route.js            # /chatbot routes
   â”œâ”€â”€ conversation.route.js       # /conversation routes
   â”œâ”€â”€ message.route.js            # /message routes
   â”œâ”€â”€ openai.route.js             # /openai routes
   â”œâ”€â”€ custom.route.js             # /custom routes
   â””â”€â”€ user.route.js               # /user routes
```


---


## 4. Data Models & Schemas


### Plugin Schema (Web Backend)
**File:** `lumina-web-be/models/plugin.model.js`


```javascript
const PluginSchema = mongoose.Schema({
 // Required fields
 userEmail: { type: String, required: true },           // Developer's email
 userName: { type: String, required: true },            // Developer's name
 name: { type: String, required: true },                // Plugin name
 version: { type: String, required: true },             // e.g., "1.0.0"
 category: { type: String, required: true },            // e.g., "Academic", "Campus"
 description: { type: String, required: true },         // Plugin description
 activated: { type: Boolean, required: true },          // Is plugin live?
 schema: { type: String, required: true },              // OpenAPI YAML string
 path: { type: String, required: true },                // API path e.g., "/getResponse"


 // Optional fields
 image: { type: String, required: false },              // Base64 encoded image
 endpoint: { type: String, required: false },           // API base URL (optional for managed)
 requestBodyQueryKey: { type: String, required: false }, // e.g., "query"
 requestFormat: { type: String, required: false },      // e.g., "application/json"
 requestContentType: { type: String, required: false }, // e.g., "object"
 authType: { type: String, required: false },           // "none" | "apiKey" | "bearer"
 apiKey: { type: String, required: false },             // API key if authType != "none"


 // Deployment fields
 deploymentType: {
   type: String,
   enum: ['external', 'managed'],
   default: 'external'
 },
 functionAppName: { type: String, required: false },    // Azure Function name (managed only)
}, { timestamps: true });
```


### Chatbot Schema (Mobile Backend - embedded in User)
**File:** `Lumina-Mobile-BE/models/user.model.js`


```javascript
const chatbotSchema = new mongoose.Schema({
 userEmail: { type: String, required: true },
 userName: { type: String, required: true },
 name: { type: String, required: true },
 version: { type: String, required: true },
 image: { type: String, required: true },
 category: { type: String, required: true },
 description: { type: String, required: true },
 activated: { type: Boolean, required: true },
 schema: { type: String, required: true },              // OpenAPI YAML for SwaggerClient


 // Plugin execution fields
 endpoint: { type: String, required: false },
 path: { type: String, required: false, default: "/getResponse" },
 requestBodyQueryKey: { type: String, required: false },
 authType: { type: String, enum: ["none", "apiKey", "bearer", null] },
 apiKey: { type: String, required: false },
}, { timestamps: true });


const userSchema = new mongoose.Schema({
 email: { type: String, required: true },               // User's NTU email
 favourite_chatbot: { type: [chatbotSchema], required: false }, // Embedded array
});


// Exports both User and Chatbot models
module.exports = { User, Chatbot };
```


### Conversation Schema
**File:** `Lumina-Mobile-BE/models/conversation.model.js`


```javascript
const conversationSchema = new mongoose.Schema({
 userEmail: { type: String, required: true },           // User's email
 chatbotId: { type: String, required: true },           // "0" = default GPT, else plugin _id
 firstMessage: { type: String, required: true },        // First message content
 lastMessage: { type: String, required: false },        // Last message content
 chatbotName: { type: String, required: true },         // For display in history
}, { timestamps: true });
```


### Message Schema
**File:** `Lumina-Mobile-BE/models/message.model.js`


```javascript
const messageSchema = new mongoose.Schema({
 conversationId: { type: String, required: true },      // Reference to conversation
 fromSelf: { type: Boolean, required: true },           // true = user, false = AI
 content: { type: String, required: true },             // Message text
}, { timestamps: true });
```


### Schema Relationships Diagram


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MongoDB Collections                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  WEB BACKEND DATABASE:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚   Users     â”‚      â”‚   Plugins   â”‚                           â”‚
â”‚  â”‚  (email)    â”‚â”€â”€â”€â”€â”€â”€â”‚ (userEmail) â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â”‚ Timer Function Sync               â”‚
â”‚                              â–¼ (every 60 seconds)                â”‚
â”‚  MOBILE BACKEND DATABASE:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   Users                                  â”‚                    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                    â”‚
â”‚  â”‚  â”‚ email                                â”‚â”‚                    â”‚
â”‚  â”‚  â”‚ favourite_chatbot: [Chatbot]         â”‚â”‚â—„â”€â”€ Embedded docs   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Chatbots   â”‚      â”‚  Conversations   â”‚                      â”‚
â”‚  â”‚  (synced)   â”‚â—„â”€â”€â”€â”€â”€â”‚  (chatbotId)     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                 â”‚
â”‚                                â–¼                                 â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                       â”‚    Messages      â”‚                      â”‚
â”‚                       â”‚ (conversationId) â”‚                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```






---


## 5. API Reference


### Web Backend Routes (Port 8080)
**Base URL:** `https://lumina-web-be-deh3gwc0fre2hjgz.southeastasia-01.azurewebsites.net`


#### User Routes (`/user`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/user/email/:email` | Get user by email |
| POST | `/user/` | Create new user |
| PUT | `/user/:id` | Update user |


#### Plugin Routes (`/plugin`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/plugin/` | Get all plugins |
| GET | `/plugin/:id` | Get plugin by ID |
| GET | `/plugin/user/:email` | Get plugins by developer email |
| POST | `/plugin/` | Create new plugin |
| PUT | `/plugin/:id` | Update plugin |
| DELETE | `/plugin/:id` | Delete plugin |


#### Deploy Routes (`/api/deploy`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/deploy/:pluginId` | Deploy zip to Azure Function |


**Deploy Request:**
```javascript
// POST /api/deploy/:pluginId
// Content-Type: multipart/form-data
{
 file: <zip-file>,      // Azure Function zip package
 userEmail: "string"    // For authorization
}


// Response
{
 success: true,
 functionUrl: "https://xxx.azurewebsites.net/api/http_trigger",
 functionAppName: "lumina-plugin-xxx"
}
```


### Mobile Backend Routes (Port 3002)
**Base URL:** `https://lumina-mobile-be-cahcaybjbbhxdzf4.southeastasia-01.azurewebsites.net`


#### User Routes (`/user`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/user/:email` | Get user by email |
| POST | `/user/` | Create new user |
| PUT | `/user/:email` | Update user (add/remove favorites) |


#### Chatbot Routes (`/chatbot`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/chatbot/` | Get all chatbots (synced from web backend) |
| GET | `/chatbot/:id` | Get chatbot by ID |


#### Conversation Routes (`/conversation`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/conversation/user/:email` | Get user's conversations |
| GET | `/conversation/:id` | Get conversation by ID |
| POST | `/conversation/` | Create new conversation |
| PUT | `/conversation/:id` | Update conversation |
| DELETE | `/conversation/:id` | Delete conversation |


#### Message Routes (`/message`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/message/conversation/:conversationId` | Get messages for conversation |
| POST | `/message/` | Create new message |
| DELETE | `/message/conversation/:conversationId` | Delete all messages in conversation |


#### OpenAI Route (`/openai`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/openai/` | Send messages to Azure OpenAI GPT-4o-mini |


**OpenAI Request:**
```javascript
// POST /openai/
{
 messages: [
   { content: "Hello", fromSelf: true },
   { content: "Hi there!", fromSelf: false },
   { content: "What's the weather?", fromSelf: true }
 ]
}


// Response
{
 response: {
   choices: [
     { message: { content: "I don't have access to weather..." } }
   ]
 }
}
```


#### Custom Plugin Route (`/custom`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/custom/` | Execute custom plugin via SwaggerClient |


**Custom Plugin Request:**
```javascript
// POST /custom/
{
 message: "user query",                    // Required: current message
 schema: "openapi: 3.0.0\ninfo:...",       // Required: OpenAPI YAML
 path: "/getResponse",                     // Optional: defaults to /getResponse
 conversationHistory: [...],               // Optional: previous messages
 userEmail: "user@ntu.edu.sg",             // Optional: user identifier
 authType: "apiKey",                       // Optional: "none" | "apiKey" | "bearer"
 apiKey: "xxx",                            // Optional: API key if authType != "none"
 pluginName: "Weather Bot"                 // Optional: for logging
}


// Response
{
 response: "The weather today is..."       // Plugin response
}
```




---


## 6. Key Features & Implementation Details


### 6.1 Plugin Creation Wizard (5-Step Flow)
**File:** `lumina-web-fe/src/screens/developer/create/Create.jsx`


The plugin creation wizard guides developers through 5 steps:


| Step | Component | Purpose |
|------|-----------|---------|
| 1 | `Instruction.jsx` | Developer guidelines, checkbox agreement |
| 2 | `PluginDetailsForm.jsx` | Name, category, description, image upload |
| 3 | `PluginEndpointForm.jsx` + `DeploymentModeSelector.jsx` | Endpoint config OR zip upload |
| 4 | `TestEndpoint.jsx` | Test the configured endpoint |
| 5 | `ReviewForm.jsx` | Final review and submit |


**Key State Variables:**
```javascript
// Plugin details
const [name, setName] = useState("");
const [category, setCategory] = useState("");
const [description, setDescription] = useState("");
const [base64, setBase64] = useState("");           // Image


// Endpoint config (external deployment)
const [endpoint, setEndpoint] = useState("");       // Base URL
const [path, setPath] = useState("");               // API path
const [requestFormat, setRequestFormat] = useState("");
const [requestBodyQueryKey, setRequestBodyQueryKey] = useState("");
const [authType, setAuthType] = useState("none");
const [apiKey, setApiKey] = useState("");


// Deployment mode
const [deploymentType, setDeploymentType] = useState("external");
const [zipFile, setZipFile] = useState(null);       // For managed deployment
```


### 6.2 OpenAPI YAML Generation
**File:** `lumina-web-fe/src/screens/developer/create/Create.jsx` â†’ `generateYaml()`


The wizard auto-generates OpenAPI 3.0.0 YAML from form inputs:


```javascript
const generateYaml = ({ name, endpoint, path, requestFormat, requestContentType, requestBodyQueryKey }) => {
 const yamlObject = {
   openapi: "3.0.0",
   info: { title: name + "API", version: "1.0.0" },
   servers: [{ url: endpoint }],
   paths: {
     [path]: {
       post: {
         operationId: "getResponse",              // IMPORTANT: Must match SwaggerClient call
         requestBody: {
           required: true,
           content: {
             [requestFormat]: {
               schema: {
                 type: requestContentType,        // "object" for JSON
                 properties: {
                   [requestBodyQueryKey]: { type: "string" }
                 }
               }
             }
           }
         },
         responses: { 200: { content: { "application/json": { schema: { type: "string" } } } } }
       }
     }
   }
 };
 return yaml.dump(yamlObject);
};
```


### 6.3 Azure AD Authentication


#### Web Frontend (MSAL)
**File:** `lumina-web-fe/src/config.js`


```javascript
export const authConfig = {
 clientId: "3c79dd79-7c34-4cda-9973-25849a553f51",
 tenantId: "0f8289d7-df22-4c3e-89b7-0fb1bcea61ab",
 authority: "https://login.microsoftonline.com/common",
 redirectUri: "https://ashy-moss-01833a500.3.azurestaticapps.net",
 scopes: ["User.Read", "openid", "email", "profile"],
};
```


#### Mobile Frontend (expo-auth-session)
**File:** `Lumina-Mobile-FE/config/authConfig.js`


```javascript
export const authConfig = {
 clientId: "71519bba-3a1e-4a1c-9924-49754f9e992c",
 tenantId: "0f8289d7-df22-4c3e-89b7-0fb1bcea61ab",
 authority: "https://login.microsoftonline.com/common/v2.0",
 scopes: ["openid", "profile", "email", "User.Read"],
 redirectScheme: "com.lumina",                    // Custom URI scheme
};
```


### 6.4 GPT-4o-mini Integration
**File:** `Lumina-Mobile-BE/controllers/openai.controller.js`


```javascript
const getResponse = async (req, res) => {
 const { messages } = req.body;


 const payload = {
   messages: [
     { role: "system", content: [{ type: "text", text: "You are an AI assistant..." }] },
     ...messages.map((msg) => ({
       role: msg.fromSelf ? "user" : "assistant",  // Convert fromSelf to OpenAI role
       content: [{ type: "text", text: msg.content }],
     })),
   ],
   temperature: 0.7,
   top_p: 0.95,
   max_tokens: 800,
 };


 const API = `${process.env.AZURE_OPENAI_API_BASE}?api-version=${process.env.AZURE_OPENAI_APIVERSION}`;
 const headers = { "Content-Type": "application/json", "api-key": process.env.AZURE_OPENAI_APIKEY };


 const response = await axios.post(API, payload, { headers });
 res.status(200).json({ response: response.data });
};
```


### 6.5 Custom Plugin Execution (SwaggerClient)
**File:** `Lumina-Mobile-BE/controllers/custom.controller.js`


**Flow:**
1. Parse OpenAPI YAML schema
2. Initialize SwaggerClient with auth config
3. Execute operation dynamically based on path
4. Return plugin response


```javascript
// Load and parse schema
const loadSchema = async ({ schema, authType, apiKey }) => {
 const parsedSchema = yaml.load(schema);
 let clientConfig = { spec: parsedSchema };


 // Add authentication if needed
 if (authType === "apiKey") {
   clientConfig.requestInterceptor = (req) => {
     req.headers["X-API-Key"] = apiKey;
     return req;
   };
 } else if (authType === "bearer") {
   clientConfig.requestInterceptor = (req) => {
     req.headers["Authorization"] = `Bearer ${apiKey}`;
     return req;
   };
 }


 return SwaggerClient(clientConfig);
};


// Call the endpoint dynamically
const callEndpoint = async ({ client, message, path }) => {
 const operation = client.spec.paths[path];
 const operationId = operation?.post?.operationId || "getResponse";
 const requestBodyQueryKey = Object.keys(operation.post.requestBody.content["application/json"].schema.properties)[0];


 const response = await client.execute({
   operationId: operationId,
   requestBody: { [requestBodyQueryKey]: message },
 });


 return response.body;
};
```




---


## 7. Deployment Architecture


### Current Production URLs


| Component | URL |
|-----------|-----|
| Web Frontend | `https://ashy-moss-01833a500.3.azurestaticapps.net` |
| Web Backend | `https://lumina-web-be-deh3gwc0fre2hjgz.southeastasia-01.azurewebsites.net` |
| Mobile Backend | `https://lumina-mobile-be-cahcaybjbbhxdzf4.southeastasia-01.azurewebsites.net` |


### Deployment Modes


#### External Deployment (Current Default)
- Developer provides their own API endpoint
- Lumina stores the endpoint URL and calls it at runtime
- **Pros:** Full control, any hosting provider
- **Cons:** Developer manages infrastructure


#### Managed Deployment (Planned Enhancement)
- Developer uploads a zip file with Azure Function code
- Lumina deploys to Azure Functions automatically
- **Pros:** Zero infrastructure management
- **Cons:** Limited to Azure Functions, Python runtime


**Managed Deployment Flow:**
```
Developer uploads zip â†’ Web Backend â†’ Azure Resource Manager API
                                          â”‚
                                          â–¼
                             Create Function App
                             Deploy code from zip
                             Set environment variables
                                          â”‚
                                          â–¼
                             Return function URL to plugin schema
```


### Plugin Sync Mechanism
An Azure Timer Function runs every 60 seconds to sync plugins:


```
Web Backend (Plugins) â”€â”€â–º Timer Function â”€â”€â–º Mobile Backend (Chatbots)
      â”‚                    (every 60s)              â”‚
      â”‚                                             â”‚
      â””â”€â”€ Source of truth                           â””â”€â”€ Synced copy
```


**Sync Fields:** userEmail, userName, name, version, image, category, description, activated, schema, endpoint, path, requestBodyQueryKey, authType, apiKey


---


## 8. Environment Variables


### lumina-web-be/.env
```bash
# Database
MONGODB_URI=mongodb+srv://...@cluster.mongodb.net/lumina-web?...


# CORS
FRONTEND_ORIGIN=https://ashy-moss-01833a500.3.azurestaticapps.net


# Azure Deployment (for managed plugins)
AZURE_SUBSCRIPTION_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_TENANT_ID=0f8289d7-df22-4c3e-89b7-0fb1bcea61ab
AZURE_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxx
AZURE_RESOURCE_GROUP=lumina-rg
AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;...
```


### Lumina-Mobile-BE/.env
```bash
# Database
MONGODB_URI=mongodb+srv://...@cluster.mongodb.net/lumina-mobile?...


# Azure OpenAI
AZURE_OPENAI_API_BASE=https://xxx.openai.azure.com/openai/deployments/gpt-4o-mini/chat/completions
AZURE_OPENAI_APIVERSION=2024-02-15-preview
AZURE_OPENAI_APIKEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


# Environment
NODE_ENV=production
PORT=3002
```


### lumina-web-fe (No .env - config.js instead)
See `lumina-web-fe/src/config.js` for Azure AD and API configuration.


### Lumina-Mobile-FE (No .env - authConfig.js instead)
See `Lumina-Mobile-FE/config/authConfig.js` for Azure AD and API configuration.


### Debugging Environment Variables
**Mobile Backend Debug Endpoint:**
```
GET /debug/env
```
Returns status of critical environment variables (masked for security).




---


## 9. Common Issues & Troubleshooting Guide


### ğŸ”´ CRITICAL BUGS (Known Issues)


#### BUG #7: Promise.all Syntax Error - Orphaned Messages
**Severity:** CRITICAL
**File:** `Lumina-Mobile-FE/components/CustomConversation.jsx` (Lines 53-56)


**Problem:**
```javascript
// âŒ WRONG - Promise.all expects an array, not comma-separated arguments
await Promise.all(
 axios.delete("/conversation/" + id),
 axios.delete("/message/conversation/" + id)
);
```


**Impact:** Only the first delete executes. Messages are NOT deleted when conversations are deleted â†’ database bloat.


**Fix:**
```javascript
// âœ… CORRECT - Use array syntax
await Promise.all([
 axios.delete("/conversation/" + id),
 axios.delete("/message/conversation/" + id)
]);
```


---


#### BUG #8: Stale Closure - Missing Latest Message
**Severity:** CRITICAL
**File:** `Lumina-Mobile-FE/app/conversation/[id].jsx` (Lines 104-263)


**Problem:**
```javascript
const getResponse = useCallback(async () => {
 const response = await axios.post("/openai", {
   messages: messages,  // âŒ Uses stale messages from closure
 });
}, [messages, conversationId, chatbot]);
```


**Impact:** GPT-4o receives incomplete conversation history - missing the user's latest message!


**Fix:** Use functional state update to get latest messages:
```javascript
const getResponse = useCallback(async () => {
 setMessages((prevMessages) => {
   const messagesToSend = prevMessages.filter(msg => msg.content !== "Fetching response...");
   axios.post("/openai", { messages: messagesToSend }).then(response => {
     // Handle response...
   });
   return [...prevMessages, { content: "Fetching response...", fromSelf: false }];
 });
}, [conversationId, chatbot]);
```


---


#### BUG #4: Broken Favourite Logic - Array Comparison
**Severity:** HIGH
**Files:**
- `Lumina-Mobile-FE/app/(tabs)/home.jsx` (Line 30)
- `Lumina-Mobile-FE/app/chatbots/discover.jsx` (Line 25)
- `Lumina-Mobile-FE/app/chatbots/favourites.jsx` (Line 25)


**Problem:**
```javascript
// âŒ WRONG - .includes() compares by reference, not value
if (favouriteChatbots.includes(chatbot)) {
```


**Impact:** Favourite/unfavourite functionality is completely broken!


**Fix:**
```javascript
// âœ… CORRECT - Compare by ID
if (favouriteChatbots.some((favChatbot) => favChatbot._id === chatbot._id)) {
```


---


### ğŸŸ¡ MEDIUM SEVERITY BUGS


#### Missing useEffect Dependencies
**Files:**
- `Lumina-Mobile-FE/app/(tabs)/home.jsx` (Lines 97-99)
- `Lumina-Mobile-FE/app/(tabs)/conversation-history.jsx` (Lines 49-52)
- `Lumina-Mobile-FE/app/chatbots/[id].jsx` (Lines 98-100)


**Problem:**
```javascript
// âŒ Missing email in dependency array
useEffect(() => {
 fetchChatbots();
}, []);
```


**Fix:**
```javascript
// âœ… Add email dependency
useEffect(() => {
 if (email) {
   fetchChatbots();
 }
}, [email]);
```


---


### Common Error Scenarios & Solutions


#### "Plugin not responding" / Empty Response
1. **Check OpenAPI schema validity:**
  - `operationId` must be `"getResponse"` (or match what SwaggerClient expects)
  - `requestBody.content` must match the expected format
  - `servers[0].url` must be the correct base URL


2. **Check authentication:**
  - Verify `authType` matches what the plugin expects
  - Ensure `apiKey` is set in mobile backend's chatbot record


3. **Debug with logs:**
  - Check mobile backend logs for `pluginLogger` output
  - Look for "PLUGIN REQUEST" and "PLUGIN RESPONSE" logs


#### "Cannot read properties of undefined"
Usually caused by:
1. Missing data from API response
2. Stale state in React components
3. Race conditions in async operations


**Common locations:**
- `conversation/[id].jsx` - Check `chatbot` object before accessing properties
- `custom.controller.js` - Check `operation` exists before accessing `operationId`


#### Azure OpenAI Errors
**Debug endpoint:** `GET /debug/env` on mobile backend


Common issues:
- `AZURE_OPENAI_API_BASE` must include full path to deployment
- `AZURE_OPENAI_APIKEY` must be set (check length in debug output)
- API version must match deployed model


#### Authentication Failures
**Web Portal:**
- Check `redirectUri` matches Azure AD app registration
- Ensure `clientId` is correct for web app


**Mobile App:**
- Check `redirectScheme` matches `app.json` scheme
- Ensure `clientId` is correct for mobile app (different from web!)




---


## 10. Code Patterns & Conventions


### State Management


#### Mobile Frontend (React Native)
- **Context API** for global state (auth, user data)
- **useState/useCallback** for component state
- **File:** `Lumina-Mobile-FE/context/AuthContext.jsx`


```javascript
// Pattern: Auth context provides email and favorites globally
const { email, favouriteChatbots, setFavouriteChatbots } = useAuth();
```


#### Web Frontend (React)
- **Context API** for plugin state
- **MSAL hooks** for authentication
- **File:** `lumina-web-fe/src/context/PluginContext.js`


```javascript
// Pattern: Get logged-in user from MSAL
const email = useMsal().instance.getActiveAccount().username;
```


### API Call Patterns


#### Axios Configuration
Both frontends configure axios with a base URL:


```javascript
// Mobile: Lumina-Mobile-FE/config/axiosConfig.js
axios.defaults.baseURL = apiConfig.baseURL;


// Web: lumina-web-fe/src/config/axiosConfig.js
const instance = axios.create({ baseURL: apiConfig.baseURL });
```


#### Standard API Call Pattern
```javascript
// Pattern used throughout codebase
try {
 const response = await axios.get("/endpoint");
 setData(response.data);
} catch (error) {
 console.error("Error:", error);
}
```


### Error Handling Patterns


#### Backend Controllers
```javascript
// Pattern: Validate required fields, return 400 for client errors
if (!message) {
 return res.status(400).json({ error: "message is required" });
}


// Pattern: Catch and return 500 for server errors
try {
 // ... operation
 res.status(200).json({ data });
} catch (error) {
 res.status(500).json({ error: error.message });
}
```


#### Frontend Error Handling
```javascript
// Pattern: Log errors, optionally show user feedback
catch (error) {
 console.error("Error fetching data:", error.response ? error.response.data : error.message);
}
```


### Naming Conventions


| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | `ChatBotCard.jsx`, `PluginDetailsForm.jsx` |
| Files (routes) | kebab-case | `conversation-history.jsx` |
| Files (dynamic) | [param].jsx | `[id].jsx` |
| Functions | camelCase | `fetchChatbots`, `handleSubmit` |
| State setters | set + Name | `setMessages`, `setEndpoint` |
| API routes | lowercase | `/user`, `/chatbot`, `/conversation` |
| MongoDB fields | camelCase | `userEmail`, `chatbotId`, `fromSelf` |


### File Organization
- **Controllers:** One per resource (`user.controller.js`, `chatbot.controller.js`)
- **Routes:** Mirror controllers (`user.route.js`, `chatbot.route.js`)
- **Models:** One per collection (`user.model.js`, `conversation.model.js`)
- **Components:** Grouped by feature (`components/create/`, `components/plugin/`)


---


## 11. Critical File Reference


### Most Frequently Modified Files


| File | Purpose | Key Functions/Components |
|------|---------|-------------------------|
| `Lumina-Mobile-FE/app/conversation/[id].jsx` | Chat interface | `handleSend`, `getResponse`, message rendering |
| `lumina-web-fe/src/screens/developer/create/Create.jsx` | Plugin wizard | `generateYaml`, `handleSubmit`, step navigation |
| `Lumina-Mobile-BE/controllers/custom.controller.js` | Plugin execution | `loadSchema`, `callEndpoint`, `customEndpoint` |
| `Lumina-Mobile-BE/controllers/openai.controller.js` | GPT integration | `getResponse` |
| `lumina-web-fe/src/config.js` | Auth config | `authConfig`, `msalConfig` |
| `Lumina-Mobile-FE/config/authConfig.js` | Auth config | `authConfig`, `apiConfig` |


### Key Entry Points


| Component | Entry Point | Purpose |
|-----------|-------------|---------|
| Mobile App | `Lumina-Mobile-FE/app/index.jsx` | Login screen, auth flow |
| Mobile Tabs | `Lumina-Mobile-FE/app/(tabs)/_layout.jsx` | Tab navigation |
| Web App | `lumina-web-fe/src/App.js` | Router, protected routes |
| Mobile Backend | `Lumina-Mobile-BE/index.js` | Express server, route setup |
| Web Backend | `lumina-web-be/index.js` | Express server, route setup |


### Configuration Files


| File | Contains |
|------|----------|
| `lumina-web-fe/src/config.js` | Azure AD clientId, tenantId, redirectUri, scopes |
| `Lumina-Mobile-FE/config/authConfig.js` | Azure AD config for mobile, API baseURL |
| `lumina-web-be/index.js` | CORS settings, route registration, port |
| `Lumina-Mobile-BE/index.js` | Route registration, MongoDB connection, port |


### Schema/Model Files


| File | Models |
|------|--------|
| `lumina-web-be/models/plugin.model.js` | Plugin (with deployment fields) |
| `Lumina-Mobile-BE/models/user.model.js` | User, Chatbot (embedded) |
| `Lumina-Mobile-BE/models/conversation.model.js` | Conversation |
| `Lumina-Mobile-BE/models/message.model.js` | Message |




---


## 12. Development Workflow


### Running Locally


#### Mobile Backend
```bash
cd Lumina/Lumina-Mobile-BE
npm install
# Create .env file with required variables
npm start
# Server runs on http://localhost:3002
```


#### Web Backend
```bash
cd Lumina/lumina-web-be
npm install
# Create .env file with required variables
npm start
# Server runs on http://localhost:8080
```


#### Mobile Frontend (Expo)
```bash
cd Lumina/Lumina-Mobile-FE
npm install
# Update config/authConfig.js to point to local backend:
# baseURL: "http://<your-ip>:3002"
npx expo start
# Scan QR code with Expo Go app
```


#### Web Frontend
```bash
cd Lumina/lumina-web-fe
npm install
# Update src/config.js to point to local backend:
# baseURL: "http://localhost:8080"
npm start
# Opens http://localhost:3000
```


### Local Development Tips


1. **Mobile to Local Backend:**
  - Use your machine's IP address, not `localhost`
  - Example: `http://10.91.53.37:3002`
  - Update `Lumina-Mobile-FE/config/axiosConfig.js`


2. **CORS Issues:**
  - Web backend allows `*` origin by default
  - For production, set `FRONTEND_ORIGIN` in `.env`


3. **Azure AD Redirect:**
  - For local web testing, add `http://localhost:3000` to Azure AD redirect URIs
  - Update `redirectUri` in `config.js`


### Testing Changes


#### Plugin Creation Flow
1. Create plugin via web portal
2. Wait 60 seconds for sync (or manually trigger sync function)
3. Check mobile app for new chatbot
4. Test chat functionality


#### OpenAI Integration
1. Verify `AZURE_OPENAI_*` environment variables
2. Use `/debug/env` endpoint to check status
3. Send test message to default chatbot (chatbotId="0")


#### Custom Plugin Execution
1. Create plugin with valid OpenAPI schema
2. Ensure `operationId: "getResponse"` in schema
3. Test endpoint before submitting
4. Check mobile backend logs for `pluginLogger` output


### Deployment


#### Web Frontend (Azure Static Web Apps)
- Push to main branch triggers automatic deployment
- Check Azure Portal for deployment status


#### Backends (Azure App Services)
- Configure deployment from GitHub or use Azure CLI
- Ensure environment variables are set in App Service Configuration


---


## 13. Integration Context


### Current System Status


| Feature | Status | Notes |
|---------|--------|-------|
| Azure AD Authentication | âœ… Working | Both web and mobile |
| Plugin Creation | âœ… Working | 5-step wizard |
| External Plugin Deployment | âœ… Working | Developer-hosted endpoints |
| Managed Plugin Deployment | ğŸš§ In Progress | Azure Functions integration |
| Plugin Sync | âœ… Working | Timer Function every 60s |
| Default GPT-4o Chat | âœ… Working | chatbotId="0" |
| Custom Plugin Chat | âœ… Working | SwaggerClient execution |
| Conversation History | âœ… Working | With known bugs |
| Favorites System | âš ï¸ Buggy | Array comparison issue |


### Planned Enhancements


#### Phase 1: Managed Deployment (Current Focus)
- Upload zip file with Azure Function code
- Automatic deployment to Azure Functions
- Endpoint URL auto-populated in plugin schema


**Files to modify:**
- `lumina-web-be/controllers/deploy.controller.js` - Deployment logic
- `lumina-web-be/services/deploymentService.js` - Azure SDK integration
- `lumina-web-fe/src/components/create/DeploymentModeSelector.jsx` - UI


#### Phase 2: Plugin Marketplace
- Admin approval workflow
- Plugin ratings and reviews
- Category browsing improvements


#### Phase 3: Advanced Features
- Multi-turn context for custom plugins
- Plugin analytics dashboard
- Conversation export


### API Contract Requirements


For a plugin to work with Lumina, it must:


1. **Accept POST requests** at the configured path
2. **Accept JSON body** with a query parameter:
  ```json
  { "query": "user message" }
  ```
3. **Return JSON response** with the answer:
  ```json
  { "response": "bot response" }
  ```
  Or just a string:
  ```json
  "bot response"
  ```


4. **Handle authentication** (if configured):
  - API Key: `X-API-Key` header
  - Bearer: `Authorization: Bearer <token>` header


### Example Plugin OpenAPI Schema


```yaml
openapi: 3.0.0
info:
 title: My Plugin API
 version: 1.0.0
servers:
 - url: https://my-plugin.example.com
paths:
 /getResponse:
   post:
     operationId: getResponse
     requestBody:
       required: true
       content:
         application/json:
           schema:
             type: object
             properties:
               query:
                 type: string
     responses:
       '200':
         content:
           application/json:
             schema:
               type: string
```


---


## Quick Reference Cheat Sheet


### "Where is X implemented?"


| Feature | Location |
|---------|----------|
| Chat message sending | `Lumina-Mobile-FE/app/conversation/[id].jsx` â†’ `handleSend()` |
| GPT-4o integration | `Lumina-Mobile-BE/controllers/openai.controller.js` |
| Custom plugin execution | `Lumina-Mobile-BE/controllers/custom.controller.js` |
| Plugin creation | `lumina-web-fe/src/screens/developer/create/Create.jsx` |
| OpenAPI YAML generation | `lumina-web-fe/src/screens/developer/create/Create.jsx` â†’ `generateYaml()` |
| Azure AD login (mobile) | `Lumina-Mobile-FE/app/index.jsx` |
| Azure AD login (web) | `lumina-web-fe/src/config.js` + MSAL |
| Favorites toggle | `Lumina-Mobile-FE/app/chatbots/[id].jsx` |
| Conversation history | `Lumina-Mobile-FE/app/(tabs)/conversation-history.jsx` |
| Plugin sync | Azure Timer Function (external) |


### "How do I fix X?"


| Issue | Solution |
|-------|----------|
| Plugin not appearing in mobile | Wait 60s for sync, check `activated: true` |
| GPT not responding | Check `/debug/env`, verify Azure OpenAI keys |
| Custom plugin error | Check `pluginLogger` output in backend logs |
| Auth redirect failure | Verify `redirectUri`/`redirectScheme` in Azure AD |
| Favorites not working | Fix array comparison (use `.some()` not `.includes()`) |
| Orphaned messages | Fix Promise.all syntax (use array) |


---


*Document generated for LLM context. Last updated: 2026-06-01*






